---
title: 'DH Quarterly Reporting'
author_details: "Alana Little, NEPHU (alana.little@austin.org.au)"
version_details: "v2.0, 25/09/2025"
output: 
  html_document: 
    code_folding: none
    toc: true
    toc_depth: 3
    toc_float: true
knit: (function(input, ...) {
  rmarkdown::render(input, output_file = paste0("2026 Q1", " DH Quarterly Reporting"), output_dir = "../Reports") })
---

```{css, echo = FALSE}
/* */ 
.main-container {
    max-width: 1000px;
}

h1.title {
  font-weight: bold;
  font-size: 20px;
  color: #191d43;
}

h1 {
  font-weight: bold;
  font-size: 20px;
  color: #5bc788;
}

h2 {
  font-weight: bold;
  font-size: 18px;
  color: #5bc788;
}

h3 {
  font-weight: bold;
  font-size: 16px;
  color: #5bc788;
}

body {
  font-size: 14px;
}
```


```{r, echo = FALSE, message = FALSE}
#
knitr::opts_chunk$set(echo    = FALSE, 
                      warning = FALSE, 
                      message = FALSE)

options(knitr.kable.NA = '--')

here::i_am("Code/01_quarterly_reporting_dh.Rmd")
```


```{r}
# Install the pacman package if you don't already have it
if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               janitor,
               lubridate,
               here,
               rmarkdown,
               knitr,
               kableExtra,
               writexl)
```


```{r}
# Dates
quarter_start <- lubridate::ymd("2025-07-01")
quarter_end   <- lubridate::ymd("2025-09-30")

file_date <- format(quarter_end, format = "%Y%m%d")

# Note: FBWB disease excluded
conditions_urgent <- c("Anthrax", 
                       "Botulism", 
                       "Candida auris", 
                       "Cholera",
                       "Diphtheria", 
                       #"Food-borne or water-borne illness",
                       "Haemolytic Uraemic Syndrome", 
                       "Haemophilus influenzae type B infection", 
                       "Hepatitis A",
                       "Invasive Group A Streptococcus",
                       "Japanese encephalitis",
                       "Legionellosis",
                       "Listeriosis",
                       "Lyssavirus - Australian Bat Lyssavirus",
                       "Lyssavirus - other",
                       "Measles",
                       "Meningococcal infection",
                       "Middle East Respiratory Syndrome (MERS)",
                       "Mpox",
                       "Murray Valley encephalitis virus infection",
                       "Paratyphoid",
                       "Plague",
                       "Poliomyelitis",
                       "Rabies",
                       "Severe Acute Respiratory Syndrome (SARS)",
                       "Smallpox",
                       "Tularaemia",
                       "Typhoid",
                       "Viral haemorrhagic fevers",
                       "Yellow fever")

nephu_lgas <- c("Banyule (C)", "Boroondara (C)", "Darebin (C)", "Hume (C)",
                "Knox (C)", "Manningham (C)", "Maroondah (C)", "Nillumbik (S)",
                "Whitehorse (C)", "Whittlesea (C)", "Yarra (C)", "Yarra Ranges (S)")
```


```{r}
# Read in case linelist
linelist_raw <- readxl::read_xlsx(paste0(here::here(), "/Data/NEPHUCaseLinelist_", file_date, ".xlsx"),
                                  sheet     = 1,
                                  guess_max = min(100000, Inf)) %>% 
  #
  janitor::clean_names() %>% 
  #
  dplyr::select(phess_id,
                event_date,
                event_type,
                condition,
                organism_cause,
                event_classification,
                final_classification = most_recent_event_classfication,
                lga_residence = local_government_area,
                lphu_residence = local_public_health_unit,
                indigenous_status,
                follow_up_required = follow_up_indicated_by_epi,
                reason_for_follow_up,
                investigation_status,
                date_signed_dh = date_time_noted,
                date_signed_lphu = date_221,
                risk_factors,
                travel_overseas = has_the_case_recently_travelled_overseas,
                enteric_highrisk = high_risk_group,
                enteric_highrisk_type = specify_138)

# Restrict to residents of NEPHU LGAs
# Note: FBWB disease excluded
# Separate legionellosis into longbeachae vs. pneumophila/others
cases_nephu <- linelist_raw %>% 
  dplyr::filter(event_type == "Case") %>%
  dplyr::filter(condition != "Food-borne or water-borne illness") %>% 
  dplyr::filter(lga_residence %in% nephu_lgas) %>% 
  #
  dplyr::mutate(condition = dplyr::case_when(
      organism_cause == "Legionella longbeachae" ~ "Legionella longbeachae",
      condition == "Legionellosis"               ~ "Legionella pneumophila",
      TRUE ~ condition)) %>% 
  #
  dplyr::distinct(phess_id, .keep_all = TRUE)

# Restrict to confirmed, probable, and/or suspected notifications
cases_nephu <- cases_nephu %>% 
  dplyr::filter(stringr::str_detect(event_classification, "Confirmed") |
                stringr::str_detect(event_classification, "Probable") |
                stringr::str_detect(event_classification, "Suspected"))

# Restrict to notifications signed out by DH during reporting period
cases_nephu <- cases_nephu %>%
  tidyr::separate_longer_delim(c(date_signed_dh, date_signed_lphu), delim = ";") %>% 
  #
  dplyr::filter(!is.na(follow_up_required)) %>% 
  #
  dplyr::distinct(phess_id, .keep_all = TRUE) %>% 
  #
  dplyr::mutate(signout_date = lubridate::dmy(stringr::str_extract(date_signed_dh, "[0-9]{2}/[0-9]{2}/[0-9]{4}"))) %>% 
  #
  dplyr::filter(signout_date >= quarter_start & signout_date <= quarter_end)

# Read in conditions reference list
# Note: the Conditions Reference List is saved in the Monthly Surveillance Report folder
root_folder <- str_extract(getwd(), "^.+Epidemiology")

subfolder_reference <- "Epi reports/Monthly Surveillance Report/Data/Reference"

reference_conditions <- readxl::read_xlsx(file.path(root_folder, subfolder_reference, "ConditionsReferenceList.xlsx"),
                                          sheet     = 1,
                                          guess_max = min(100000, Inf)) %>%
  janitor::clean_names() %>% 
  #
  dplyr::distinct(condition, .keep_all = TRUE)

# Join condition information to case data
cases_nephu <- cases_nephu %>% 
  dplyr::left_join(reference_conditions, by = "condition")

# Data wrangling
cases_nephu <- cases_nephu %>% 
  dplyr::mutate(event_date       = lubridate::ymd(event_date),
                date_signed_dh   = lubridate::dmy_hm(date_signed_dh, tz = Sys.timezone()),
                date_signed_lphu = lubridate::dmy_hm(date_signed_lphu, tz = Sys.timezone()),
                #
                response_seconds = as.numeric(date_signed_lphu - date_signed_dh),
                response_minutes = as.numeric(response_seconds / 60),
                response_hours   = as.numeric(response_minutes / 60),
                #
                response_24hr = dplyr::case_when(
                  response_hours <= 24 ~ "Within 24hr",
                  TRUE ~ "More than 24hr")) %>% 
  #
  dplyr::arrange(condition,
                 event_date)

# Subset urgent notifications
urgent_nephu <- cases_nephu %>% 
  dplyr::filter(condition %in% conditions_urgent)
```


```{r}
# Read in outbreak linelist
outbreaks_nephu <- readxl::read_xlsx(paste0(here::here(), "/Data/NEPHUOutbreakLinelist_", file_date, ".xlsx"),
                                     sheet     = 1,
                                     guess_max = min(100000, Inf)) %>% 
  #
  janitor::clean_names() %>% 
  #
  dplyr::filter(local_government_area %in% nephu_lgas) %>%
  #
  dplyr::select(phess_id,
                event_date,
                event_name,
                lga  = local_government_area,
                lphu = local_public_health_unit,
                condition,
                organism_cause,
                setting = setting_where_exposure_occurred_19,
                classification = most_recent_case_classfication,
                investigation_status)
```

## Total number of notifications signed out for follow-up and percentage with follow-up completed

Data were extracted from PHESS for all notifiable conditions (excluding food-borne or water-borne illness) signed out from the Department of Health to NEPHU between `r format(quarter_start, format = "%d/%m/%Y")` and `r format(quarter_end, format = "%d/%m/%Y")`. Notifications were included in the analyses if they were classified as suspected, probable, or confirmed at any point during follow-up.

**Total number of notifications signed out for follow-up and number and percentage of notifications with follow-up completed, NEPHU, notifications signed out between `r format(quarter_start, format = "%d/%m/%Y")` and `r format(quarter_end, format = "%d/%m/%Y")**

```{r}
#
cases_signedout <- cases_nephu %>% 
  dplyr::group_by(reporting_group, short_name) %>% 
  dplyr::summarise(signedout_n = n()) %>% 
  dplyr::ungroup() %>% 
  #
  dplyr::arrange(reporting_group, short_name)

cases_completed <- cases_nephu %>% 
  dplyr::filter(investigation_status == "Completed") %>%
  #
  dplyr::group_by(reporting_group, short_name) %>% 
  dplyr::summarise(completed_n = n()) %>% 
  dplyr::ungroup() %>% 
  #
  dplyr::arrange(reporting_group, short_name)

cases_signedout <- cases_signedout %>% 
  dplyr::left_join(cases_completed, by = c("reporting_group", "short_name")) %>%
  #
  replace_na(list(completed_n = 0)) %>% 
  #
  janitor::adorn_totals() %>% 
  #
  dplyr::mutate(completed_percent = round(completed_n / signedout_n * 100, digits = 1)) %>% 
  #
  dplyr::select(reporting_group,
                short_name,
                completed_n,
                signedout_n,
                completed_percent)

cases_signedout %>% 
  knitr::kable(table.attr  = "style = \"color: black;\"",
               format.args = list(big.mark = ","),
               align       = "llrrr",
               col.names   = c("Reporting group",
                               "Condition",
                               "Signed out (n)",
                               "Completed (n)",
                               "Completed (%)")) %>% 
  #
  kableExtra::kable_styling(full_width = FALSE,
                            position   = "center",
                            html_font  = "Arial",
                            font_size  = 12) %>%
  #
  kableExtra::column_spec(3:5,
                          width = "1.5in") %>% 
  #
  kableExtra::row_spec(row  = 0,
                       bold = TRUE) %>% 
  #
  kableExtra::row_spec(nrow(cases_signedout),
                       bold      = TRUE,
                       extra_css = "border-top: 2px solid lightgray; border-bottom: 2px solid lightgray;") %>% 
  #
  kableExtra::scroll_box(height = "400px")
```

***

## Total number of urgent notifications signed out for follow-up and percentage with follow-up completed

Data were extracted from PHESS for all urgent notifiable conditions signed out from the Department of Health to NEPHU between `r format(quarter_start, format = "%d/%m/%Y")` and `r format(quarter_end, format = "%d/%m/%Y")`. Notifications were included in the analyses if they were classified as suspected, probable, or confirmed at any point during follow-up.

Urgent notifiable conditions include the following: anthrax, botulism, *Candida auris*, cholera, diphtheria, haemolytic uraemic syndrome, *Haemophilus influenzae* type B, Hepatitis A, invasive Group A *Streptococcus*, invasive meningococcal disease, Japanese encephalitis, legionellosis, listeriosis, lyssavirus (Australian Bat Lyssavirus, rabies, and others), measles, Middle East Respiratory Syndrome, mpox, Murray Valley encephalitis, paratyphoid, plague, poliomyelitis, Severe Acute Respiratory Syndrome, smallpox, tularaemia, typhoid, viral haemorrhagic fevers, and yellow fever.

```{r}
#
urgent_signedout <- urgent_nephu %>%
  dplyr::group_by(reporting_group, short_name) %>% 
  dplyr::summarise(signedout_n = n()) %>% 
  dplyr::ungroup() %>% 
  #
  dplyr::arrange(reporting_group, short_name)

urgent_completed <- urgent_nephu %>% 
  dplyr::group_by(reporting_group, short_name) %>% 
  dplyr::summarise(completed_n = n()) %>% 
  dplyr::ungroup() %>% 
  #
  dplyr::arrange(reporting_group, short_name)

urgent_signedout <- urgent_signedout %>% 
  dplyr::left_join(urgent_completed, by = c("reporting_group", "short_name")) %>%
  #
  replace_na(list(completed_n = 0)) %>% 
  #
  janitor::adorn_totals() %>% 
  #
  dplyr::mutate(completed_percent = round(completed_n / signedout_n * 100, digits = 1)) %>% 
  #
  dplyr::select(reporting_group,
                short_name,
                completed_n,
                signedout_n,
                completed_percent)

urgent_signedout %>% 
  dplyr::mutate(completed_percent = sprintf("%.1f", completed_percent)) %>%
  #
  knitr::kable(table.attr  = "style = \"color: black;\"",
               format.args = list(big.mark = ","),
               align       = "llrrr",
               col.names   = c("Reporting group",
                               "Condition",
                               "Signed out (n)",
                               "Completed (n)",
                               "Completed (%)")) %>% 
  #
  kableExtra::kable_styling(full_width = FALSE,
                            position   = "center",
                            html_font  = "Arial",
                            font_size  = 12) %>%
  #
  kableExtra::column_spec(3:5,
                          width = "1.5in") %>% 
  #
  kableExtra::row_spec(row  = 0,
                       bold = TRUE) %>% 
  #
  kableExtra::row_spec(nrow(urgent_signedout),
                       bold      = TRUE,
                       extra_css = "border-top: 2px solid lightgray; border-bottom: 2px solid lightgray;")
```

***

## Total number of outbreaks closed

```{r}
#

```

***

## Percentage of urgent conditions responded to within 24 hours

Data were extracted from PHESS for all urgent notifiable conditions signed out from the Department of Health to NEPHU between `r format(quarter_start, format = "%d/%m/%Y")` and `r format(quarter_end, format = "%d/%m/%Y")`. Notifications were included in the analyses if they were classified as suspected, probable, or confirmed at any point during follow-up.

Urgent notifiable conditions include the following: anthrax, botulism, *Candida auris*, cholera, diphtheria, haemolytic uraemic syndrome, *Haemophilus influenzae* type B, Hepatitis A, invasive Group A *Streptococcus*, invasive meningococcal disease, Japanese encephalitis, legionellosis, listeriosis, lyssavirus (Australian Bat Lyssavirus, rabies, and others), measles, Middle East Respiratory Syndrome, mpox, Murray Valley encephalitis, paratyphoid, plague, poliomyelitis, Severe Acute Respiratory Syndrome, smallpox, tularaemia, typhoid, viral haemorrhagic fevers, and yellow fever.

The time between the first sign-out by the Department of Health and the first acknowledgment by NEPHU staff was calculated as a proxy measure of whether public health actions had commenced. Notifications where the time between sign-out and acknowledgement was greater than 24 hours (1,440 minutes) were manually reviewed in PHESS to check whether public health actions had commenced within 24 hours of the initial laboratory or doctor notification.

***

### Before manual review

**Time between DH signout and initial LPHU response for urgent notifiable conditions, NEPHU, notifications signed out between `r format(quarter_start, format = "%d/%m/%Y")` and `r format(quarter_end, format = "%d/%m/%Y")`**

```{r}
#
results_24hr <- cases_nephu %>% 
  dplyr::filter(condition %in% conditions_urgent) %>%
  #
  dplyr::mutate(response_24hr = factor(response_24hr,
                                       levels = c("Within 24hr", 
                                                  "More than 24hr"))) %>% 
  #
  dplyr::group_by(condition, response_24hr) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::ungroup() %>% 
  #
  tidyr::complete(condition, response_24hr,
                  fill = list(n = 0)) %>% 
  #
  tidyr::pivot_wider(names_from  = response_24hr,
                     values_from = n,
                     values_fill = 0) %>% 
  #
  janitor::clean_names() %>% 
  #
  janitor::adorn_totals("row") %>% 
  #
  dplyr::mutate(percent_within_24hr = (within_24hr / (within_24hr + more_than_24hr)) * 100,
                percent_within_24hr = sprintf("%.1f", percent_within_24hr)) %>% 
  #
  dplyr::select(condition,
                within_24hr,
                more_than_24hr,
                percent_within_24hr)

results_24hr %>% 
  knitr::kable(table.attr = "style = \"color: black;\"",
               align      = "lrrr",
               col.names  = c("Condition",
                              "Within 24hr",
                              "More than 24hr",
                              "Percent within 24hr")) %>% 
  #
  kableExtra::kable_styling(full_width = FALSE,
                            position   = "center",
                            html_font  = "Arial",
                            font_size  = 12) %>%
  #
  kableExtra::column_spec(2:4,
                          width = "1.5in") %>% 
  #
  kableExtra::row_spec(row  = 0,
                       bold = TRUE) %>% 
  #
  kableExtra::row_spec(nrow(results_24hr),
                       bold      = TRUE,
                       extra_css = "border-top: 2px solid lightgray; border-bottom: 2px solid lightgray;") %>% 
  #
  kableExtra::add_header_above(c(" " = 1,
                                 "Time between DH signout and initial LPHU response" = 3))
```


```{r}
# Create and export the linelist of cases that need manual checking
# Uncomment this code chunk as required

manual_24hr <- cases_nephu %>%
  dplyr::filter(response_24hr == "More than 24hr") %>%
  #
  dplyr::arrange(condition,
                 event_date) %>%
  #
  dplyr::mutate(event_date       = format(event_date, "%d/%m/%Y"),
                date_signed_dh   = format(date_signed_dh, "%d/%m/%Y %H:%M"),
                date_signed_lphu = format(date_signed_lphu, "%d/%m/%Y %H:%M")) %>%
  #
  dplyr::select(`PHESS ID` = phess_id,
                `Event date` = event_date,
                `Condition` = condition_short,
                `Final event classification` = final_classification,
                `Signed out by DH` = date_signed_dh,
                `Acknowledged by LPHU` = date_signed_lphu) %>%
  #
  dplyr::mutate(`Notes` = "",
                `Response within 24hr` = "")
 
# writexl::write_xlsx(manual_24hr,
#                     paste0(here::here(), "/Data", "/ManualReview_", "24hr_", file_date, ".xlsx"))
```

***

### After manual review

```{r}
# Read in results of manual review
# Uncomment this code chunk as required
linelist_24hr <- readxl::read_xlsx(paste0(here::here(), "/Data", "/ManualReview_", "24hr_", file_date, ".xlsx"),
                                   sheet     = 1,
                                   guess_max = min(100000, Inf)) %>%
  #
  janitor::clean_names() %>%
  #
  dplyr::rename(response_24hr = response_within_24hr)
```

**Time between DH signout and initial LPHU response for urgent notifiable conditions, NEPHU, notifications signed out between `r format(quarter_start, format = "%d/%m/%Y")` and `r format(quarter_end, format = "%d/%m/%Y")`**

```{r}
# Uncomment this step as required
cases_nephu <- cases_nephu %>%
  dplyr::rows_update(linelist_24hr %>%
                       dplyr::select(phess_id,
                                     response_24hr),
                     by = "phess_id")
  
results_24hr <- cases_nephu %>% 
  dplyr::mutate(response_24hr = factor(response_24hr,
                                       levels = c("Within 24hr",
                                                  "More than 24hr"))) %>% 
  #
  dplyr::group_by(condition, response_24hr) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::ungroup() %>% 
  #
  tidyr::complete(condition, response_24hr,
                  fill = list(n = 0)) %>% 
  #
  tidyr::pivot_wider(names_from  = response_24hr,
                     values_from = n,
                     values_fill = 0) %>% 
  #
  janitor::clean_names() %>% 
  #
  janitor::adorn_totals("row") %>% 
  #
  dplyr::mutate(percent_within_24hr = (within_24hr / (within_24hr + more_than_24hr)) * 100,
                percent_within_24hr = sprintf("%.1f", percent_within_24hr))

results_24hr %>% 
  knitr::kable(table.attr = "style = \"color: black;\"",
               align      = "lrrr",
               col.names  = c("Condition",
                              "Within 24hr",
                              "More than 24hr",
                              "Percent within 24hr")) %>% 
  #
  kableExtra::kable_styling(full_width = FALSE,
                            position   = "center",
                            html_font  = "Arial",
                            font_size  = 12) %>%
  #
  kableExtra::column_spec(2:4,
                          width = "1.5in") %>% 
  #
  kableExtra::row_spec(row  = 0,
                       bold = TRUE) %>% 
  #
  kableExtra::row_spec(nrow(results_24hr),
                       bold      = TRUE,
                       extra_css = "border-top: 2px solid lightgray; border-bottom: 2px solid lightgray;") %>% 
  #
  kableExtra::add_header_above(c(" " = 1,
                                 "Time between DH signout and initial LPHU response" = 3))
```

<br/>

**Urgent notifiable conditions with time between DH signout and initial LPHU response >24 hours, NEPHU, notifications signed out between `r format(quarter_start, format = "%d/%m/%Y")` and `r format(quarter_end, format = "%d/%m/%Y")`**

```{r}
# Uncomment this step as required
# Add chart title to narrative as required:
#
# <br/>
#
# **Urgent notifiable conditions with time between DH signout and initial LPHU response >24 hours, NEPHU, notifications signed out between `r format(quarter_start, format = "%d/%m/%Y")` and `r format(quarter_end, format = "%d/%m/%Y")`**
#
linelist_24hr %>%
  dplyr::select(phess_id,
                condition,
                signed_out_by_dh,
                acknowledged_by_lphu,
                notes) %>%
  #
  knitr::kable(table.attr = "style = \"color: black;\"",
               align      = "lllllll",
               col.names  = c("PHESS ID",
                              "Condition",
                              "Signed out (DH)",
                              "Acknowledged (NEPHU)",
                              "Manual review outcome")) %>%
  #
  kableExtra::kable_styling(full_width = TRUE,
                            position   = "center",
                            html_font  = "Arial",
                            font_size  = 12) %>%
  #
  kableExtra::column_spec(3:4,
                          width = "1in") %>%
  #
  kableExtra::row_spec(row  = 0,
                       bold = TRUE) %>%
  #
  kableExtra::row_spec(nrow(linelist_24hr),
                       extra_css = "border-bottom: 2px solid lightgray;")
```

<br/>

<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>
